import { NodeView, } from '@tiptap/core';
import { AngularRenderer } from './AngularRenderer';
class AngularNodeView extends NodeView {
    mount() {
        const injector = this.options.injector;
        const props = {
            editor: this.editor,
            node: this.node,
            decorations: this.decorations,
            selected: false,
            extension: this.extension,
            getPos: () => this.getPos(),
            updateAttributes: (attributes = {}) => this.updateAttributes(attributes),
            deleteNode: () => this.deleteNode(),
            view: this.view,
            innerDecorations: this.innerDecorations,
            HTMLAttributes: this.HTMLAttributes,
        };
        this.handleSelectionUpdate = this.handleSelectionUpdate.bind(this);
        this.editor.on('selectionUpdate', this.handleSelectionUpdate);
        // create renderer
        this.renderer = new AngularRenderer(this.component, injector, props);
        // Register drag handler
        if (this.extension.config.draggable) {
            this.renderer.elementRef.nativeElement.ondragstart = (e) => {
                this.onDragStart(e);
            };
        }
        this.contentDOMElement = this.node.isLeaf ? null : document.createElement(this.node.isInline ? 'span' : 'div');
        if (this.contentDOMElement) {
            // For some reason the whiteSpace prop is not inherited properly in Chrome and Safari
            // With this fix it seems to work fine
            // See: https://github.com/ueberdosis/tiptap/issues/1197
            this.contentDOMElement.style.whiteSpace = 'inherit';
            // Required for editable node views
            // The content won't be rendered if `editable` is set to `false`
            this.renderer.detectChanges();
        }
        this.appendContendDom();
    }
    get dom() {
        return this.renderer.dom;
    }
    get contentDOM() {
        if (this.node.isLeaf) {
            return null;
        }
        return this.contentDOMElement;
    }
    appendContendDom() {
        const contentElement = this.dom.querySelector('[data-node-view-content]');
        if (this.contentDOMElement
            && contentElement
            && !contentElement.contains(this.contentDOMElement)) {
            contentElement.appendChild(this.contentDOMElement);
        }
    }
    handleSelectionUpdate() {
        const { from, to } = this.editor.state.selection;
        if (from <= this.getPos() && to >= this.getPos() + this.node.nodeSize) {
            this.selectNode();
        }
        else {
            this.deselectNode();
        }
    }
    update(node, decorations, innerDecorations) {
        const updateProps = () => {
            this.renderer.updateProps({ node, decorations: decorations });
        };
        if (this.options.update) {
            const oldNode = this.node;
            const oldDecorations = this.decorations;
            this.node = node;
            this.decorations = decorations;
            this.innerDecorations = innerDecorations;
            return this.options.update({
                oldNode,
                oldDecorations,
                innerDecorations,
                newNode: node,
                newDecorations: decorations,
                updateProps: () => updateProps(),
            });
        }
        if (node.type !== this.node.type) {
            return false;
        }
        if (node === this.node && this.decorations === decorations) {
            return true;
        }
        this.node = node;
        this.decorations = decorations;
        updateProps();
        return true;
    }
    selectNode() {
        this.renderer.updateProps({ selected: true });
    }
    deselectNode() {
        this.renderer.updateProps({ selected: false });
    }
    destroy() {
        this.renderer.destroy();
        this.editor.off('selectionUpdate', this.handleSelectionUpdate);
        this.contentDOMElement = null;
    }
}
export const AngularNodeViewRenderer = (ViewComponent, options) => {
    return (props) => {
        return new AngularNodeView(ViewComponent, props, options);
    };
};
//# sourceMappingURL=data:application/json;base64,eyJ2ZXJzaW9uIjozLCJmaWxlIjoiTm9kZVZpZXdSZW5kZXJlci5qcyIsInNvdXJjZVJvb3QiOiIiLCJzb3VyY2VzIjpbIi4uLy4uLy4uLy4uL3Byb2plY3RzL25neC10aXB0YXAvc3JjL2xpYi9Ob2RlVmlld1JlbmRlcmVyLnRzIl0sIm5hbWVzIjpbXSwibWFwcGluZ3MiOiJBQUNBLE9BQU8sRUFDRyxRQUFRLEdBRWpCLE1BQU0sY0FBYyxDQUFDO0FBSXRCLE9BQU8sRUFBRSxlQUFlLEVBQUUsTUFBTSxtQkFBbUIsQ0FBQztBQWlCcEQsTUFBTSxlQUFnQixTQUFRLFFBQWdGO0lBS25HLEtBQUs7UUFDWixNQUFNLFFBQVEsR0FBRyxJQUFJLENBQUMsT0FBTyxDQUFDLFFBQW9CLENBQUM7UUFFbkQsTUFBTSxLQUFLLEdBQWtCO1lBQzNCLE1BQU0sRUFBRSxJQUFJLENBQUMsTUFBTTtZQUNuQixJQUFJLEVBQUUsSUFBSSxDQUFDLElBQUk7WUFDZixXQUFXLEVBQUUsSUFBSSxDQUFDLFdBQVc7WUFDN0IsUUFBUSxFQUFFLEtBQUs7WUFDZixTQUFTLEVBQUUsSUFBSSxDQUFDLFNBQVM7WUFDekIsTUFBTSxFQUFFLEdBQUcsRUFBRSxDQUFDLElBQUksQ0FBQyxNQUFNLEVBQUU7WUFDM0IsZ0JBQWdCLEVBQUUsQ0FBQyxVQUFVLEdBQUcsRUFBRSxFQUFFLEVBQUUsQ0FBQyxJQUFJLENBQUMsZ0JBQWdCLENBQUMsVUFBVSxDQUFDO1lBQ3hFLFVBQVUsRUFBRSxHQUFHLEVBQUUsQ0FBQyxJQUFJLENBQUMsVUFBVSxFQUFFO1lBQ25DLElBQUksRUFBRSxJQUFJLENBQUMsSUFBSTtZQUNmLGdCQUFnQixFQUFFLElBQUksQ0FBQyxnQkFBZ0I7WUFDdkMsY0FBYyxFQUFFLElBQUksQ0FBQyxjQUFjO1NBQ3BDLENBQUM7UUFFRixJQUFJLENBQUMscUJBQXFCLEdBQUcsSUFBSSxDQUFDLHFCQUFxQixDQUFDLElBQUksQ0FBQyxJQUFJLENBQUMsQ0FBQztRQUNuRSxJQUFJLENBQUMsTUFBTSxDQUFDLEVBQUUsQ0FBQyxp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QyxPQUFPLEVBQUUsQ0FBQztRQUN4QixJQUFJLENBQUMsTUFBTSxDQUFDLEdBQUcsQ0FBQyxpQkFBaUIsRUFBRSxJQUFJLENBQUMscUJBQXFCLENBQUMsQ0FBQztRQUMvRCxJQUFJLENBQUMsaUJBQWlCLEdBQUcsSUFBSSxDQUFDO0lBQ2hDLENBQUM7Q0FDRjtBQUVELE1BQU0sQ0FBQyxNQUFNLHVCQUF1QixHQUFHLENBQ3JDLGFBQTZDLEVBQzdDLE9BQWdELEVBQzlCLEVBQUU7SUFDcEIsT0FBTyxDQUFDLEtBQTRCLEVBQUUsRUFBRTtRQUN0QyxPQUFPLElBQUksZUFBZSxDQUFDLGFBQWEsRUFBRSxLQUFLLEVBQUUsT0FBTyxDQUFDLENBQUM7SUFDNUQsQ0FBQyxDQUFDO0FBQ0osQ0FBQyxDQUFDIiwic291cmNlc0NvbnRlbnQiOlsiaW1wb3J0IHsgSW5qZWN0b3IsIFR5cGUgfSBmcm9tICdAYW5ndWxhci9jb3JlJztcbmltcG9ydCB7XG4gIEVkaXRvciwgTm9kZVZpZXcsIE5vZGVWaWV3UHJvcHMsXG4gIE5vZGVWaWV3UmVuZGVyZXIsIE5vZGVWaWV3UmVuZGVyZXJQcm9wcywgTm9kZVZpZXdSZW5kZXJlck9wdGlvbnMsIERlY29yYXRpb25XaXRoVHlwZSxcbn0gZnJvbSAnQHRpcHRhcC9jb3JlJztcbmltcG9ydCB0eXBlIHsgRGVjb3JhdGlvbiwgRGVjb3JhdGlvblNvdXJjZSB9IGZyb20gJ0B0aXB0YXAvcG0vdmlldyc7XG5pbXBvcnQgdHlwZSB7IE5vZGUgYXMgUHJvc2VNaXJyb3JOb2RlIH0gZnJvbSAnQHRpcHRhcC9wbS9tb2RlbCc7XG5cbmltcG9ydCB7IEFuZ3VsYXJSZW5kZXJlciB9IGZyb20gJy4vQW5ndWxhclJlbmRlcmVyJztcbmltcG9ydCB7IEFuZ3VsYXJOb2RlVmlld0NvbXBvbmVudCB9IGZyb20gJy4vbm9kZS12aWV3LmNvbXBvbmVudCc7XG5cbmludGVyZmFjZSBSZW5kZXJlclVwZGF0ZVByb3BzIHtcbiAgb2xkTm9kZTogUHJvc2VNaXJyb3JOb2RlO1xuICBvbGREZWNvcmF0aW9uczogcmVhZG9ubHkgRGVjb3JhdGlvbltdO1xuICBpbm5lckRlY29yYXRpb25zOiBEZWNvcmF0aW9uU291cmNlO1xuICBuZXdOb2RlOiBQcm9zZU1pcnJvck5vZGU7XG4gIG5ld0RlY29yYXRpb25zOiByZWFkb25seSBEZWNvcmF0aW9uV2l0aFR5cGVbXTtcbiAgdXBkYXRlUHJvcHM6ICgpID0+IHZvaWQ7XG59XG5cbmludGVyZmFjZSBBbmd1bGFyTm9kZVZpZXdSZW5kZXJlck9wdGlvbnMgZXh0ZW5kcyBOb2RlVmlld1JlbmRlcmVyT3B0aW9ucyB7XG4gIHVwZGF0ZT86ICgocHJvcHM6IFJlbmRlcmVyVXBkYXRlUHJvcHMpID0+IGJvb2xlYW4pIHwgbnVsbDtcbiAgaW5qZWN0b3I6IEluamVjdG9yO1xufVxuXG5jbGFzcyBBbmd1bGFyTm9kZVZpZXcgZXh0ZW5kcyBOb2RlVmlldzxUeXBlPEFuZ3VsYXJOb2RlVmlld0NvbXBvbmVudD4sIEVkaXRvciwgQW5ndWxhck5vZGVWaWV3UmVuZGVyZXJPcHRpb25zPiB7XG4gIHJlbmRlcmVyITogQW5ndWxhclJlbmRlcmVyPEFuZ3VsYXJOb2RlVmlld0NvbXBvbmVudCwgTm9kZVZpZXdQcm9wcz47XG4gIGNvbnRlbnRET01FbGVtZW50ITogSFRNTEVsZW1lbnQgfCBudWxsO1xuICBvdmVycmlkZSBkZWNvcmF0aW9ucyE6IHJlYWRvbmx5IERlY29yYXRpb25XaXRoVHlwZVtdO1xuXG4gIG92ZXJyaWRlIG1vdW50KCkge1xuICAgIGNvbnN0IGluamVjdG9yID0gdGhpcy5vcHRpb25zLmluamVjdG9yIGFzIEluamVjdG9yO1xuXG4gICAgY29uc3QgcHJvcHM6IE5vZGVWaWV3UHJvcHMgPSB7XG4gICAgICBlZGl0b3I6IHRoaXMuZWRpdG9yLFxuICAgICAgbm9kZTogdGhpcy5ub2RlLFxuICAgICAgZGVjb3JhdGlvbnM6IHRoaXMuZGVjb3JhdGlvbnMsXG4gICAgICBzZWxlY3RlZDogZmFsc2UsXG4gICAgICBleHRlbnNpb246IHRoaXMuZXh0ZW5zaW9uLFxuICAgICAgZ2V0UG9zOiAoKSA9PiB0aGlzLmdldFBvcygpLFxuICAgICAgdXBkYXRlQXR0cmlidXRlczogKGF0dHJpYnV0ZXMgPSB7fSkgPT4gdGhpcy51cGRhdGVBdHRyaWJ1dGVzKGF0dHJpYnV0ZXMpLFxuICAgICAgZGVsZXRlTm9kZTogKCkgPT4gdGhpcy5kZWxldGVOb2RlKCksXG4gICAgICB2aWV3OiB0aGlzLnZpZXcsXG4gICAgICBpbm5lckRlY29yYXRpb25zOiB0aGlzLmlubmVyRGVjb3JhdGlvbnMsXG4gICAgICBIVE1MQXR0cmlidXRlczogdGhpcy5IVE1MQXR0cmlidXRlcyxcbiAgICB9O1xuXG4gICAgdGhpcy5oYW5kbGVTZWxlY3Rpb25VcGRhdGUgPSB0aGlzLmhhbmRsZVNlbGVjdGlvblVwZGF0ZS5iaW5kKHRoaXMpO1xuICAgIHRoaXMuZWRpdG9yLm9uKCdzZWxlY3Rpb25VcGRhdGUnLCB0aGlzLmhhbmRsZVNlbGVjdGlvblVwZGF0ZSk7XG5cbiAgICAvLyBjcmVhdGUgcmVuZGVyZXJcbiAgICB0aGlzLnJlbmRlcmVyID0gbmV3IEFuZ3VsYXJSZW5kZXJlcih0aGlzLmNvbXBvbmVudCwgaW5qZWN0b3IsIHByb3BzKTtcblxuICAgIC8vIFJlZ2lzdGVyIGRyYWcgaGFuZGxlclxuICAgIGlmICh0aGlzLmV4dGVuc2lvbi5jb25maWcuZHJhZ2dhYmxlKSB7XG4gICAgICB0aGlzLnJlbmRlcmVyLmVsZW1lbnRSZWYubmF0aXZlRWxlbWVudC5vbmRyYWdzdGFydCA9IChlOiBEcmFnRXZlbnQpID0+IHtcbiAgICAgICAgdGhpcy5vbkRyYWdTdGFydChlKTtcbiAgICAgIH07XG4gICAgfVxuXG4gICAgdGhpcy5jb250ZW50RE9NRWxlbWVudCA9IHRoaXMubm9kZS5pc0xlYWYgPyBudWxsIDogZG9jdW1lbnQuY3JlYXRlRWxlbWVudCh0aGlzLm5vZGUuaXNJbmxpbmUgPyAnc3BhbicgOiAnZGl2Jyk7XG5cbiAgICBpZiAodGhpcy5jb250ZW50RE9NRWxlbWVudCkge1xuICAgICAgLy8gRm9yIHNvbWUgcmVhc29uIHRoZSB3aGl0ZVNwYWNlIHByb3AgaXMgbm90IGluaGVyaXRlZCBwcm9wZXJseSBpbiBDaHJvbWUgYW5kIFNhZmFyaVxuICAgICAgLy8gV2l0aCB0aGlzIGZpeCBpdCBzZWVtcyB0byB3b3JrIGZpbmVcbiAgICAgIC8vIFNlZTogaHR0cHM6Ly9naXRodWIuY29tL3VlYmVyZG9zaXMvdGlwdGFwL2lzc3Vlcy8xMTk3XG4gICAgICB0aGlzLmNvbnRlbnRET01FbGVtZW50LnN0eWxlLndoaXRlU3BhY2UgPSAnaW5oZXJpdCc7XG5cbiAgICAgIC8vIFJlcXVpcmVkIGZvciBlZGl0YWJsZSBub2RlIHZpZXdzXG4gICAgICAvLyBUaGUgY29udGVudCB3b24ndCBiZSByZW5kZXJlZCBpZiBgZWRpdGFibGVgIGlzIHNldCB0byBgZmFsc2VgXG4gICAgICB0aGlzLnJlbmRlcmVyLmRldGVjdENoYW5nZXMoKTtcbiAgICB9XG5cbiAgICB0aGlzLmFwcGVuZENvbnRlbmREb20oKTtcbiAgfVxuXG4gIG92ZXJyaWRlIGdldCBkb20oKSB7XG4gICAgcmV0dXJuIHRoaXMucmVuZGVyZXIuZG9tO1xuICB9XG5cbiAgb3ZlcnJpZGUgZ2V0IGNvbnRlbnRET00oKSB7XG4gICAgaWYgKHRoaXMubm9kZS5pc0xlYWYpIHtcbiAgICAgIHJldHVybiBudWxsO1xuICAgIH1cblxuICAgIHJldHVybiB0aGlzLmNvbnRlbnRET01FbGVtZW50O1xuICB9XG5cbiAgcHJpdmF0ZSBhcHBlbmRDb250ZW5kRG9tKCkge1xuICAgIGNvbnN0IGNvbnRlbnRFbGVtZW50ID0gdGhpcy5kb20ucXVlcnlTZWxlY3RvcignW2RhdGEtbm9kZS12aWV3LWNvbnRlbnRdJyk7XG5cbiAgICBpZiAoXG4gICAgICB0aGlzLmNvbnRlbnRET01FbGVtZW50XG4gICAgICAmJiBjb250ZW50RWxlbWVudFxuICAgICAgJiYgIWNvbnRlbnRFbGVtZW50LmNvbnRhaW5zKHRoaXMuY29udGVudERPTUVsZW1lbnQpXG4gICAgKSB7XG4gICAgICBjb250ZW50RWxlbWVudC5hcHBlbmRDaGlsZCh0aGlzLmNvbnRlbnRET01FbGVtZW50KTtcbiAgICB9XG4gIH1cblxuICBoYW5kbGVTZWxlY3Rpb25VcGRhdGUoKSB7XG4gICAgY29uc3QgeyBmcm9tLCB0byB9ID0gdGhpcy5lZGl0b3Iuc3RhdGUuc2VsZWN0aW9uO1xuXG4gICAgaWYgKGZyb20gPD0gdGhpcy5nZXRQb3MoKSAmJiB0byA+PSB0aGlzLmdldFBvcygpICsgdGhpcy5ub2RlLm5vZGVTaXplKSB7XG4gICAgICB0aGlzLnNlbGVjdE5vZGUoKTtcbiAgICB9IGVsc2Uge1xuICAgICAgdGhpcy5kZXNlbGVjdE5vZGUoKTtcbiAgICB9XG4gIH1cblxuICB1cGRhdGUoXG4gICAgbm9kZTogUHJvc2VNaXJyb3JOb2RlLFxuICAgIGRlY29yYXRpb25zOiByZWFkb25seSBEZWNvcmF0aW9uW10sXG4gICAgaW5uZXJEZWNvcmF0aW9uczogRGVjb3JhdGlvblNvdXJjZSxcbiAgKTogYm9vbGVhbiB7XG4gICAgY29uc3QgdXBkYXRlUHJvcHMgPSAoKSA9PiB7XG4gICAgICB0aGlzLnJlbmRlcmVyLnVwZGF0ZVByb3BzKHsgbm9kZSwgZGVjb3JhdGlvbnM6IGRlY29yYXRpb25zIGFzIERlY29yYXRpb25XaXRoVHlwZVtdIH0pO1xuICAgIH07XG5cbiAgICBpZiAodGhpcy5vcHRpb25zLnVwZGF0ZSkge1xuICAgICAgY29uc3Qgb2xkTm9kZSA9IHRoaXMubm9kZTtcbiAgICAgIGNvbnN0IG9sZERlY29yYXRpb25zID0gdGhpcy5kZWNvcmF0aW9ucztcblxuICAgICAgdGhpcy5ub2RlID0gbm9kZTtcbiAgICAgIHRoaXMuZGVjb3JhdGlvbnMgPSBkZWNvcmF0aW9ucyBhcyBEZWNvcmF0aW9uV2l0aFR5cGVbXTtcbiAgICAgIHRoaXMuaW5uZXJEZWNvcmF0aW9ucyA9IGlubmVyRGVjb3JhdGlvbnM7XG5cbiAgICAgIHJldHVybiB0aGlzLm9wdGlvbnMudXBkYXRlKHtcbiAgICAgICAgb2xkTm9kZSxcbiAgICAgICAgb2xkRGVjb3JhdGlvbnMsXG4gICAgICAgIGlubmVyRGVjb3JhdGlvbnMsXG4gICAgICAgIG5ld05vZGU6IG5vZGUsXG4gICAgICAgIG5ld0RlY29yYXRpb25zOiBkZWNvcmF0aW9ucyBhcyBEZWNvcmF0aW9uV2l0aFR5cGVbXSxcbiAgICAgICAgdXBkYXRlUHJvcHM6ICgpID0+IHVwZGF0ZVByb3BzKCksXG4gICAgICB9KTtcbiAgICB9XG5cbiAgICBpZiAobm9kZS50eXBlICE9PSB0aGlzLm5vZGUudHlwZSkge1xuICAgICAgcmV0dXJuIGZhbHNlO1xuICAgIH1cblxuICAgIGlmIChub2RlID09PSB0aGlzLm5vZGUgJiYgdGhpcy5kZWNvcmF0aW9ucyA9PT0gZGVjb3JhdGlvbnMpIHtcbiAgICAgIHJldHVybiB0cnVlO1xuICAgIH1cblxuICAgIHRoaXMubm9kZSA9IG5vZGU7XG4gICAgdGhpcy5kZWNvcmF0aW9ucyA9IGRlY29yYXRpb25zIGFzIERlY29yYXRpb25XaXRoVHlwZVtdO1xuICAgIHVwZGF0ZVByb3BzKCk7XG5cbiAgICByZXR1cm4gdHJ1ZTtcbiAgfVxuXG4gIHNlbGVjdE5vZGUoKSB7XG4gICAgdGhpcy5yZW5kZXJlci51cGRhdGVQcm9wcyh7IHNlbGVjdGVkOiB0cnVlIH0pO1xuICB9XG5cbiAgZGVzZWxlY3ROb2RlKCkge1xuICAgIHRoaXMucmVuZGVyZXIudXBkYXRlUHJvcHMoeyBzZWxlY3RlZDogZmFsc2UgfSk7XG4gIH1cblxuICBkZXN0cm95KCkge1xuICAgIHRoaXMucmVuZGVyZXIuZGVzdHJveSgpO1xuICAgIHRoaXMuZWRpdG9yLm9mZignc2VsZWN0aW9uVXBkYXRlJywgdGhpcy5oYW5kbGVTZWxlY3Rpb25VcGRhdGUpO1xuICAgIHRoaXMuY29udGVudERPTUVsZW1lbnQgPSBudWxsO1xuICB9XG59XG5cbmV4cG9ydCBjb25zdCBBbmd1bGFyTm9kZVZpZXdSZW5kZXJlciA9IChcbiAgVmlld0NvbXBvbmVudDogVHlwZTxBbmd1bGFyTm9kZVZpZXdDb21wb25lbnQ+LFxuICBvcHRpb25zOiBQYXJ0aWFsPEFuZ3VsYXJOb2RlVmlld1JlbmRlcmVyT3B0aW9ucz4sXG4pOiBOb2RlVmlld1JlbmRlcmVyID0+IHtcbiAgcmV0dXJuIChwcm9wczogTm9kZVZpZXdSZW5kZXJlclByb3BzKSA9PiB7XG4gICAgcmV0dXJuIG5ldyBBbmd1bGFyTm9kZVZpZXcoVmlld0NvbXBvbmVudCwgcHJvcHMsIG9wdGlvbnMpO1xuICB9O1xufTtcbiJdfQ==